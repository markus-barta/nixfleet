# NixFleet - csb1 Deployment (with Traefik)
#
# This is the deployment-specific configuration for csb1.
# Requires Traefik reverse proxy with csb1_traefik network.
#
# Deploy: docker compose -f docker-compose.csb1.yml up -d

services:
  nixfleet:
    build:
      context: ..
      args:
        - GIT_HASH=${GIT_HASH:-unknown}
        - GIT_VERSION=${GIT_VERSION:-dev}
    container_name: nixfleet
    restart: unless-stopped
    environment:
      - NIXFLEET_DATA_DIR=/data
      - NIXFLEET_SERVER_HOST=csb1
      - NIXFLEET_PASSWORD_HASH=${NIXFLEET_PASSWORD_HASH}
      - NIXFLEET_TOTP_SECRET=${NIXFLEET_TOTP_SECRET:-}
      - NIXFLEET_SESSION_SECRETS=${NIXFLEET_SESSION_SECRETS}
      - NIXFLEET_API_TOKEN=${NIXFLEET_API_TOKEN}
      - NIXFLEET_AGENT_TOKEN_HASH_SECRET=${NIXFLEET_AGENT_TOKEN_HASH_SECRET}
      - NIXFLEET_ALLOW_SHARED_AGENT_TOKEN=${NIXFLEET_ALLOW_SHARED_AGENT_TOKEN:-true}
      - NIXFLEET_AUTO_PROVISION_AGENT_TOKENS=${NIXFLEET_AUTO_PROVISION_AGENT_TOKENS:-true}
      - NIXFLEET_TRUST_PROXY_HEADERS=${NIXFLEET_TRUST_PROXY_HEADERS:-true}
      - NIXFLEET_TRUSTED_PROXY_IPS=${NIXFLEET_TRUSTED_PROXY_IPS:-}
    volumes:
      - nixfleet-data:/data
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=csb1_traefik"
      - "traefik.http.routers.nixfleet.rule=Host(`fleet.barta.cm`)"
      - "traefik.http.routers.nixfleet.tls=true"
      - "traefik.http.routers.nixfleet.tls.certresolver=default"
      - "traefik.http.routers.nixfleet.middlewares=cloudflarewarp@file"
      - "traefik.http.services.nixfleet.loadbalancer.server.port=8000"
    networks:
      - csb1_traefik

volumes:
  nixfleet-data:

networks:
  csb1_traefik:
    external: true
