# NixFleet v2 - csb1 Deployment (with Traefik)
#
# This is the deployment-specific configuration for csb1.
# Requires Traefik reverse proxy with csb1_traefik network.
#
# Deploy: docker compose -f docker/docker-compose.csb1.yml --env-file ~/secrets/nixfleet.env pull && \
#         docker compose -f docker/docker-compose.csb1.yml --env-file ~/secrets/nixfleet.env up -d
#
# Images built by GitHub Actions: ghcr.io/markus-barta/nixfleet
# Tags: master (latest from main), <sha> (specific commit), <version> (releases)

services:
  nixfleet:
    image: ghcr.io/markus-barta/nixfleet:master
    container_name: nixfleet
    restart: unless-stopped
    environment:
      - NIXFLEET_DATA_DIR=/data
      - NIXFLEET_LISTEN=:8000
      - NIXFLEET_PASSWORD_HASH=${NIXFLEET_PASSWORD_HASH}
      - NIXFLEET_TOTP_SECRET=${NIXFLEET_TOTP_SECRET:-}
      - NIXFLEET_API_TOKEN=${NIXFLEET_API_TOKEN}
      - NIXFLEET_ALLOWED_ORIGINS=${NIXFLEET_ALLOWED_ORIGINS:-}
    volumes:
      - nixfleet-data:/data
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=csb1_traefik"
      - "traefik.http.routers.nixfleet.rule=Host(`fleet.barta.cm`)"
      - "traefik.http.routers.nixfleet.tls=true"
      - "traefik.http.routers.nixfleet.tls.certresolver=default"
      - "traefik.http.routers.nixfleet.middlewares=cloudflarewarp@file"
      - "traefik.http.services.nixfleet.loadbalancer.server.port=8000"
    networks:
      - csb1_traefik

volumes:
  nixfleet-data:

networks:
  csb1_traefik:
    external: true
