# NixFleet v2 - Example Deployment (with Traefik)
#
# ⚠️  EXAMPLE ONLY - NOT USED IN PRODUCTION
#
# This is a reference deployment configuration showing how to run NixFleet
# behind Traefik reverse proxy. Production csb1 uses ~/docker/docker-compose.yml
# (main compose file with all services).
#
# Use this as a template for NEW deployments, not for csb1.
#
# Example deploy:
#   docker compose -f docker-compose.example.yml --env-file ~/secrets/nixfleet.env pull
#   docker compose -f docker-compose.example.yml --env-file ~/secrets/nixfleet.env up -d
#
# Images built by GitHub Actions: ghcr.io/markus-barta/nixfleet
# Tags: master (latest from main), <sha> (specific commit), <version> (releases)

services:
  nixfleet:
    image: ghcr.io/markus-barta/nixfleet:master
    container_name: nixfleet
    restart: unless-stopped
    environment:
      - NIXFLEET_DATA_DIR=/data
      - NIXFLEET_LISTEN=:8000
      - NIXFLEET_PASSWORD_HASH=${NIXFLEET_PASSWORD_HASH}
      - NIXFLEET_SESSION_SECRET=${NIXFLEET_SESSION_SECRET}
      - NIXFLEET_AGENT_TOKEN=${NIXFLEET_AGENT_TOKEN}
      - NIXFLEET_TOTP_SECRET=${NIXFLEET_TOTP_SECRET:-}
      - NIXFLEET_ALLOWED_ORIGINS=${NIXFLEET_ALLOWED_ORIGINS:-}
      - NIXFLEET_LOG_LEVEL=${NIXFLEET_LOG_LEVEL:-info}
      - NIXFLEET_VERSION_URL=${NIXFLEET_VERSION_URL:-}
      - NIXFLEET_GITHUB_TOKEN=${NIXFLEET_GITHUB_TOKEN:-}
      - NIXFLEET_GITHUB_REPO=${NIXFLEET_GITHUB_REPO:-}
    volumes:
      - nixfleet-data:/data
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=csb1_traefik"
      - "traefik.http.routers.nixfleet.rule=Host(`fleet.barta.cm`)"
      - "traefik.http.routers.nixfleet.tls=true"
      - "traefik.http.routers.nixfleet.tls.certresolver=default"
      - "traefik.http.routers.nixfleet.middlewares=cloudflarewarp@file"
      - "traefik.http.services.nixfleet.loadbalancer.server.port=8000"
    networks:
      - csb1_traefik

volumes:
  nixfleet-data:

networks:
  csb1_traefik:
    external: true
