# NixFleet - Docker Compose for csb1 deployment
#
# Deploy with: docker compose up -d
#
# Environment variables (set in .env):
#   NIXFLEET_PASSWORD_HASH  - bcrypt hash of admin password
#   NIXFLEET_TOTP_SECRET    - Base32-encoded TOTP secret (optional)
#   NIXFLEET_API_TOKEN      - Token for agent authentication

services:
  nixfleet:
    build:
      context: .
      args:
        - GIT_HASH=${GIT_HASH:-unknown}
    container_name: nixfleet
    restart: unless-stopped
    environment:
      - NIXFLEET_DATA_DIR=/data
      - NIXFLEET_PASSWORD_HASH=${NIXFLEET_PASSWORD_HASH}
      - NIXFLEET_TOTP_SECRET=${NIXFLEET_TOTP_SECRET:-}
      - NIXFLEET_API_TOKEN=${NIXFLEET_API_TOKEN}
    volumes:
      - nixfleet-data:/data
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=csb1_traefik"
      - "traefik.http.routers.nixfleet.rule=Host(`fleet.barta.cm`)"
      - "traefik.http.routers.nixfleet.tls=true"
      - "traefik.http.routers.nixfleet.tls.certresolver=default"
      - "traefik.http.routers.nixfleet.middlewares=cloudflarewarp@file"
      - "traefik.http.services.nixfleet.loadbalancer.server.port=8000"
    networks:
      - csb1_traefik

volumes:
  nixfleet-data:

networks:
  csb1_traefik:
    external: true
