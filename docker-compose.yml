# NixFleet - Docker Compose - EXAMPLE
#
# Generic deployment configuration.
# Copy this file and customize for your environment.
#
# Required environment variables (create .env file):
#   NIXFLEET_PASSWORD_HASH  - bcrypt hash of admin password
#   NIXFLEET_SESSION_SECRETS - Comma-separated secrets for signed session cookies (rotation supported)
#   NIXFLEET_AGENT_TOKEN_HASH_SECRET - Secret used to hash per-host agent tokens in DB
#   NIXFLEET_API_TOKEN      - Shared agent token (recommended only as a bootstrap / migration aid)
#
# Optional:
#   NIXFLEET_TOTP_SECRET    - Base32-encoded TOTP secret for 2FA
#   NIXFLEET_REQUIRE_TOTP   - Set to "true" to enforce 2FA
#   GIT_HASH                - Git commit hash for version tracking

services:
  nixfleet:
    build:
      context: .
      args:
        - GIT_HASH=${GIT_HASH:-unknown}
    container_name: nixfleet
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - NIXFLEET_DATA_DIR=/data
      - NIXFLEET_PASSWORD_HASH=${NIXFLEET_PASSWORD_HASH}
      - NIXFLEET_TOTP_SECRET=${NIXFLEET_TOTP_SECRET:-}
      - NIXFLEET_SESSION_SECRETS=${NIXFLEET_SESSION_SECRETS}
      - NIXFLEET_API_TOKEN=${NIXFLEET_API_TOKEN}
      - NIXFLEET_AGENT_TOKEN_HASH_SECRET=${NIXFLEET_AGENT_TOKEN_HASH_SECRET}
      - NIXFLEET_ALLOW_SHARED_AGENT_TOKEN=${NIXFLEET_ALLOW_SHARED_AGENT_TOKEN:-true}
      - NIXFLEET_AUTO_PROVISION_AGENT_TOKENS=${NIXFLEET_AUTO_PROVISION_AGENT_TOKENS:-true}
      - NIXFLEET_REQUIRE_TOTP=${NIXFLEET_REQUIRE_TOTP:-false}
      - NIXFLEET_TRUST_PROXY_HEADERS=${NIXFLEET_TRUST_PROXY_HEADERS:-false}
      - NIXFLEET_TRUSTED_PROXY_IPS=${NIXFLEET_TRUSTED_PROXY_IPS:-}
    volumes:
      - nixfleet-data:/data
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

volumes:
  nixfleet-data:
